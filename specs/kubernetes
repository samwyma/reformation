#!/usr/bin/env bash
source "$(cd "$(dirname "$0")" && pwd)/../pretty-print"

title "Kubernetes"

kubectl_version="v1.18.10"
helm_version="v1.18.2"
kops_version="v3.4.0"
argo_version="v2.11.3"
tilt_version="v0.17.6"

if ! [ -x "$(command -v docker)" ]; then
  print_error "Docker is required, it should be included in the 'specs'"
  return 1
fi

mkdir -p "$HOME/.bin"
if [[ ! ":$PATH:" == *":$HOME/.bin:"* ]]; then
  print_error "\$PATH entry missing...add to your shell's rc file: PATH=\"\$HOME/.bin:\$PATH\""
fi

### kubectl
if [ "$FORCE" = true ] || [ ! -f "$HOME/.bin/kubectl" ] || [ "$(kubectl version --client --output=json | jq -r .clientVersion.gitVersion)" != $kubectl_version ]; then
  echo_install "Installing kubectl $kubectl_version"
  if curl --fail --retry 3 --retry-delay 1 -L -s https://storage.googleapis.com/kubernetes-release/release/$kubectl_version/bin/darwin/amd64/kubectl >"$HOME/.bin/kubectl" && chmod +x "$HOME/.bin/kubectl"; then
    print_in_green "${bold}✓ installed!${normal}\n"
  else
    print_in_red "${bold}✗ error!!!${normal}\n"
  fi
else
  print_success_muted "kubectl"
fi

### helm
if [ "$FORCE" = true ] || [ ! -f "$HOME/.bin/helm" ] || ! helm version --client --short | grep -q "$helm_version+"; then
  echo_install "Installing helm $helm_version"
  if curl --fail --retry 3 --retry-delay 1 -L -s https://get.helm.sh/helm-$helm_version-darwin-amd64.tar.gz | tar xf - --strip=1 -C "$HOME/.bin" darwin-amd64/helm; then
    print_in_green "${bold}✓ installed!${normal}\n"
  else
    print_in_red "${bold}✗ error!!!${normal}\n"
  fi
else
  print_success_muted "helm"
fi

### kops
if [ "$FORCE" = true ] || [ ! -f "$HOME/.bin/kops" ] || [[ "v$(kops version --short)" != "$kops_version" ]]; then
  echo_install "Installing kops $kops_version"
  if curl --fail --retry 3 --retry-delay 1 -L -s https://github.com/kubernetes/kops/releases/download/${kops_version}/kops-darwin-amd64 -o "$HOME/.bin/kops" && chmod +x "$HOME/.bin/kops"; then
    print_in_green "${bold}✓ installed!${normal}\n"
  else
    print_in_red "${bold}✗ error!!!${normal}\n"
  fi
else
  print_success_muted "kops"
fi

### argo
if [ "$FORCE" = true ] || [ ! -f "$HOME/.bin/argo" ] || ! argo version | grep -q "$argo_version"; then
  echo_install "Installing argo $argo_version"
  if curl --fail --retry 3 --retry-delay 1 -L -s https://github.com/argoproj/argo/releases/download/${argo_version}/argo-darwin-amd64 -o "$HOME/.bin/argo" && chmod +x "$HOME/.bin/argo"; then
    print_in_green "${bold}✓ installed!${normal}\n"
  else
    print_in_red "${bold}✗ error!!!${normal}\n"
  fi
else
  print_success_muted "argo"
fi

### tilt
if [ "$FORCE" = true ] || [ ! command -v tilt ] >/dev/null 2>&1 || ! tilt version | grep -q "$tilt_version"; then
  echo_install "Installing tilt $tilt_version"
  if curl --fail --retry 3 --retry-delay 1 -L -s https://raw.githubusercontent.com/tilt-dev/tilt/${tilt_version}/scripts/install.sh | bash >/dev/null 2>&1; then
    print_in_green "${bold}✓ installed!${normal}\n"
  else
    print_in_red "${bold}✗ error!!!${normal}\n"
  fi
else
  print_success_muted "tilt"
fi

### promtool
if [ "$FORCE" = true ] || [ ! -f "$HOME/.bin/promtool" ]; then
  echo_install "Installing promtool"
  docker run --rm -e GOOS=darwin -e GOARCH=amd64 -v "$HOME/.bin":/data golang /bin/bash -c \
    "go get github.com/prometheus/prometheus/cmd/promtool && cp /go/bin/darwin_amd64/promtool /data"
  print_in_green "${bold}✓ installed!${normal}\n"
else
  print_success_muted "promtool"
fi

if [ "$FORCE" = true ] || [ ! -f "$HOME/.bin/jb" ]; then
  echo_install "Installing jsonnet-bundler"
  docker run --rm -e GOOS=darwin -e GOARCH=amd64 -v "$HOME/.bin":/data golang /bin/bash -c \
    "go get github.com/jsonnet-bundler/jsonnet-bundler/cmd/jb && cp /go/bin/darwin_amd64/jb /data"
  print_in_green "${bold}✓ installed!${normal}\n"
else
  print_success_muted "jsonnet-bundler"
fi

if [ "$FORCE" = true ] || [ ! -f "$HOME/.bin/gojsontoyaml" ]; then
  echo_install "Installing gojsontoyaml"
  docker run --rm -e GOOS=darwin -e GOARCH=amd64 -v "$HOME/.bin":/data golang /bin/bash -c \
    "go get github.com/brancz/gojsontoyaml && cp /go/bin/darwin_amd64/gojsontoyaml /data"
  print_in_green "${bold}✓ installed!${normal}\n"
else
  print_success_muted "gojsontoyaml"
fi

if [ "$FORCE" = true ] || [ ! -f "$HOME/.bin/render" ]; then
  echo_install "Installing render"
  docker run --rm -e GOOS=darwin -e GOARCH=amd64 -v "$HOME/.bin":/data golang /bin/bash -c \
    "go get github.com/VirtusLab/render && cp /go/bin/darwin_amd64/render /data"
  print_in_green "${bold}✓ installed!${normal}\n"
else
  print_success_muted "render"
fi
